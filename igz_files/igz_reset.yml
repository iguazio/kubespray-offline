---
- hosts: k8s_cluster
  become: true
  gather_facts: false
  tasks:

    - name: Ensure specific processes are killed
      block:
        - name: Kill leftover processes
          command: pkill -f "{{ item }}"
          register: pkill_result
          ignore_errors: true
          loop: ["kube", "flannel", "node-cache"]
          until: pkill_result.rc == 0
          retries: 5
          delay: 2

        - name: Verify process is terminated
          command: pgrep -f "{{ item }}"
          register: pgrep_result
          failed_when: pgrep_result.rc == 0
          loop: ["kube", "flannel", "node-cache"]

    - name: Get network interfaces
      shell: "ip -o -4 link show | awk -F: '/cali|flannel/ {print $2}'"
      register: interfaces
      changed_when: false

    - name: Delete network interfaces
      become: true
      command: ip link delete {{ item }}
      with_items: "{{ interfaces.stdout_lines }}"
      ignore_errors: true


    - name: Check if "/etc/canal/certs/" directory exists
      stat:
        path: "/etc/canal/certs/"
      register: canal_certs_dir

    - name: Wipe "/etc/canal/certs/" directory if it exists
      file:
        state: absent
        path: "/etc/canal/certs/"
      when: canal_certs_dir.stat.exists
